<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.genersoft.iot.vmp.gb28181.dao.PlatformMapper">
    <insert id="add">
        INSERT INTO wvp_platform
        (enable, name, server_gb_id, server_gb_domain, server_ip, server_port, device_gb_id, device_ip,
         device_port, username, password, expires, keep_timeout, transport, character_set, ptz, rtcp, status,
         catalog_group, update_time, create_time, as_message_channel, send_stream_ip, auto_push_channel,
         catalog_with_platform, catalog_with_group, catalog_with_region, civil_code, manufacturer, model, address,
         register_way, secrecy)
        VALUES (#{enable}, #{name}, #{serverGBId}, #{serverGBDomain}, #{serverIp}, #{serverPort}, #{deviceGBId},
                #{deviceIp}, #{devicePort}, #{username}, #{password}, #{expires}, #{keepTimeout}, #{transport},
                #{characterSet}, #{ptz}, #{rtcp}, #{status}, #{catalogGroup}, #{updateTime}, #{createTime},
                #{asMessageChannel}, #{sendStreamIp}, #{autoPushChannel}, #{catalogWithPlatform}, #{catalogWithGroup},
                #{catalogWithRegion}, #{civilCode}, #{manufacturer}, #{model}, #{address}, #{registerWay}, #{secrecy})
    </insert>

    <update id="update">
        UPDATE wvp_platform
        SET update_time=#{updateTime},
            enable=#{enable},
            name=#{name},
            server_gb_id=#{serverGBId},
            server_gb_domain=#{serverGBDomain},
            server_ip=#{serverIp},
            server_port=#{serverPort},
            device_gb_id=#{deviceGBId},
            device_ip=#{deviceIp},
            device_port=#{devicePort},
            username=#{username},
            password=#{password},
            expires=#{expires},
            keep_timeout=#{keepTimeout},
            transport=#{transport},
            character_set=#{characterSet},
            ptz=#{ptz},
            rtcp=#{rtcp},
            status=#{status},
            catalog_group=#{catalogGroup},
            as_message_channel=#{asMessageChannel},
            send_stream_ip=#{sendStreamIp},
            auto_push_channel=#{autoPushChannel},
            catalog_with_platform=#{catalogWithPlatform},
            catalog_with_group=#{catalogWithGroup},
            catalog_with_region=#{catalogWithRegion},
            civil_code=#{civilCode},
            manufacturer=#{manufacturer},
            model=#{model},
            address=#{address},
            register_way=#{registerWay},
            secrecy=#{secrecy}
        WHERE id = #{id}
    </update>

    <delete id="delete">
        DELETE
        FROM wvp_platform
        WHERE id = #{id}
    </delete>

    <select id="queryList" resultType="com.genersoft.iot.vmp.gb28181.bean.Platform">
        SELECT pp.*,
        ( (SELECT count(0) FROM wvp_platform_channel pc WHERE pc.platform_id = pp.id) +
        (SELECT count(0) FROM wvp_platform_group pg WHERE pg.platform_id = pp.id) * pp.catalog_with_group +
        (SELECT count(0) FROM wvp_platform_region pr WHERE pr.platform_id = pp.id) * pp.catalog_with_region +
        pp.catalog_with_platform
        ) as channel_count
        FROM wvp_platform pp
        <where>
            <if test='query != null'>
                AND (pp.name LIKE concat('%',#{query},'%') escape '/'
                OR pp.server_gb_id LIKE concat('%',#{query},'%') escape '/')
            </if>
        </where>
        order by pp.id desc
    </select>

    <select id="getEnableParentPlatformList" resultType="com.genersoft.iot.vmp.gb28181.bean.Platform">
        SELECT *
        FROM wvp_platform
        WHERE enable = #{enable}
    </select>

    <select id="queryEnablePlatformListWithAsMessageChannel" resultType="com.genersoft.iot.vmp.gb28181.bean.Platform">
        SELECT *
        FROM wvp_platform
        WHERE enable = true
          and as_message_channel = true
    </select>

    <select id="getParentPlatByServerGBId" resultType="com.genersoft.iot.vmp.gb28181.bean.Platform">
        SELECT *
        FROM wvp_platform
        WHERE server_gb_id = #{platformGbId}
    </select>

    <select id="query" resultType="com.genersoft.iot.vmp.gb28181.bean.Platform">
        SELECT *
        FROM wvp_platform
        WHERE id = #{id}
    </select>

    <update id="updateStatus">
        UPDATE wvp_platform
        SET status=#{online}
        WHERE server_gb_id = #{platformGbID}
    </update>

    <select id="queryEnablePlatformList" resultType="com.genersoft.iot.vmp.gb28181.bean.Platform">
        SELECT *
        FROM wvp_platform
        WHERE enable = true
    </select>
</mapper>