<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.genersoft.iot.vmp.gb28181.dao.DeviceMapper">

    <select id="getDeviceByDeviceId" resultType="com.genersoft.iot.vmp.gb28181.bean.Device">
        SELECT id,
               device_id,
               coalesce(custom_name, name)       as name,
               password,
               manufacturer,
               model,
               firmware,
               transport,
               stream_mode,
               ip,
               sdp_ip,
               local_ip,
               port,
               host_address,
               expires,
               register_time,
               keepalive_time,
               create_time,
               update_time,
               charset,
               subscribe_cycle_for_catalog,
               subscribe_cycle_for_mobile_position,
               mobile_position_submission_interval,
               subscribe_cycle_for_alarm,
               ssrc_check,
               as_message_channel,
               geo_coord_sys,
               on_line,
               media_server_id,
               broadcast_push_after_ack,
               (SELECT count(0)
                FROM wvp_device_channel dc
                WHERE dc.data_type = 1
                  and dc.data_device_id = de.id) as channel_count
        FROM wvp_device de
        WHERE de.device_id = #{deviceId}
    </select>

    <insert id="add">
        INSERT INTO wvp_device
        (device_id,
         name,
         manufacturer,
         model,
         firmware,
         transport,
         stream_mode,
         media_server_id,
         ip,
         sdp_ip,
         local_ip,
         port,
         host_address,
         expires,
         register_time,
         keepalive_time,
         keepalive_interval_time,
         create_time,
         update_time,
         charset,
         subscribe_cycle_for_catalog,
         subscribe_cycle_for_mobile_position,
         mobile_position_submission_interval,
         subscribe_cycle_for_alarm,
         ssrc_check,
         as_message_channel,
         broadcast_push_after_ack,
         geo_coord_sys,
         on_line)
        VALUES (#{deviceId}, #{name}, #{manufacturer}, #{model}, #{firmware}, #{transport}, #{streamMode},
                #{mediaServerId}, #{ip}, #{sdpIp}, #{localIp}, #{port}, #{hostAddress}, #{expires}, #{registerTime},
                #{keepaliveTime}, #{keepaliveIntervalTime}, #{createTime}, #{updateTime}, #{charset},
                #{subscribeCycleForCatalog}, #{subscribeCycleForMobilePosition}, #{mobilePositionSubmissionInterval},
                #{subscribeCycleForAlarm}, #{ssrcCheck}, #{asMessageChannel}, #{broadcastPushAfterAck}, #{geoCoordSys},
                #{onLine})
    </insert>

    <update id="update">
        UPDATE wvp_device
        SET update_time=#{updateTime}
        <if test="name != null">, name=#{name}</if>
        <if test="manufacturer != null">, manufacturer=#{manufacturer}</if>
        <if test="model != null">, model=#{model}</if>
        <if test="firmware != null">, firmware=#{firmware}</if>
        <if test="transport != null">, transport=#{transport}</if>
        <if test="ip != null">, ip=#{ip}</if>
        <if test="localIp != null">, local_ip=#{localIp}</if>
        <if test="port != null">, port=#{port}</if>
        <if test="hostAddress != null">, host_address=#{hostAddress}</if>
        <if test="onLine != null">, on_line=#{onLine}</if>
        <if test="registerTime != null">, register_time=#{registerTime}</if>
        <if test="keepaliveTime != null">, keepalive_time=#{keepaliveTime}</if>
        <if test="keepaliveIntervalTime != null">, keepalive_interval_time=#{keepaliveIntervalTime}</if>
        <if test="expires != null">, expires=#{expires}</if>
        WHERE device_id=#{deviceId}
    </update>

    <select id="getDevices" resultType="com.genersoft.iot.vmp.gb28181.bean.Device">
        SELECT
        id,
        device_id,
        coalesce(custom_name, name) as name,
        password,
        manufacturer,
        model,
        firmware,
        transport,
        stream_mode,
        ip,
        sdp_ip,
        local_ip,
        port,
        host_address,
        expires,
        register_time,
        keepalive_time,
        create_time,
        update_time,
        charset,
        subscribe_cycle_for_catalog,
        subscribe_cycle_for_mobile_position,
        mobile_position_submission_interval,
        subscribe_cycle_for_alarm,
        ssrc_check,
        as_message_channel,
        broadcast_push_after_ack,
        geo_coord_sys,
        on_line,
        media_server_id,
        (SELECT count(0) FROM wvp_device_channel dc WHERE dc.data_type = #{dataType} and dc.data_device_id= de.id) as
        channel_count
        FROM wvp_device de
        <where>
            <if test='online != null'>de.on_line=${online}</if>
        </where>
        order by de.create_time desc
    </select>

    <delete id="del">
        DELETE
        FROM wvp_device
        WHERE device_id = #{deviceId}
    </delete>

    <select id="getOnlineDevices" resultType="com.genersoft.iot.vmp.gb28181.bean.Device">
        SELECT id,
               device_id,
               coalesce(custom_name, name) as name,
               password,
               manufacturer,
               model,
               firmware,
               transport,
               stream_mode,
               ip,
               sdp_ip,
               local_ip,
               port,
               host_address,
               expires,
               register_time,
               keepalive_time,
               create_time,
               update_time,
               charset,
               subscribe_cycle_for_catalog,
               subscribe_cycle_for_mobile_position,
               mobile_position_submission_interval,
               subscribe_cycle_for_alarm,
               ssrc_check,
               as_message_channel,
               broadcast_push_after_ack,
               geo_coord_sys,
               on_line
        FROM wvp_device
        WHERE on_line = true
    </select>

    <select id="getDeviceByHostAndPort" resultType="com.genersoft.iot.vmp.gb28181.bean.Device">
        SELECT id,
               device_id,
               coalesce(custom_name, name) as name,
               password,
               manufacturer,
               model,
               firmware,
               transport,
               stream_mode,
               ip,
               sdp_ip,
               local_ip,
               port,
               host_address,
               expires,
               register_time,
               keepalive_time,
               create_time,
               update_time,
               charset,
               subscribe_cycle_for_catalog,
               subscribe_cycle_for_mobile_position,
               mobile_position_submission_interval,
               subscribe_cycle_for_alarm,
               ssrc_check,
               as_message_channel,
               broadcast_push_after_ack,
               geo_coord_sys,
               on_line
        FROM wvp_device
        WHERE ip = #{host}
          AND port = #{port}
    </select>

    <update id="updateCustom">
        UPDATE wvp_device
        SET update_time=#{updateTime},
            custom_name=#{name},
            password=#{password},
            stream_mode=#{streamMode},
            ip=#{ip},
            sdp_ip=#{sdpIp},
            port=#{port},
            charset=#{charset},
            ssrc_check=#{ssrcCheck},
            as_message_channel=#{asMessageChannel},
            broadcast_push_after_ack=#{broadcastPushAfterAck},
            geo_coord_sys=#{geoCoordSys},
            media_server_id=#{mediaServerId}
        WHERE id = #{id}
    </update>

    <insert id="addCustomDevice">
        INSERT INTO wvp_device
        (device_id,
         custom_name,
         password,
         sdp_ip,
         create_time,
         update_time,
         charset,
         ssrc_check,
         as_message_channel,
         broadcast_push_after_ack,
         geo_coord_sys,
         on_line,
         stream_mode,
         media_server_id)
        VALUES (#{deviceId},
                #{name},
                #{password},
                #{sdpIp},
                #{createTime},
                #{updateTime},
                #{charset},
                #{ssrcCheck},
                #{asMessageChannel},
                #{broadcastPushAfterAck},
                #{geoCoordSys},
                #{onLine},
                #{streamMode},
                #{mediaServerId})
    </insert>

    <select id="getAll" resultType="com.genersoft.iot.vmp.gb28181.bean.Device">
        select *
        FROM wvp_device
    </select>

    <select id="queryDeviceWithAsMessageChannel" resultType="com.genersoft.iot.vmp.gb28181.bean.Device">
        select *
        FROM wvp_device
        where as_message_channel = true
    </select>

    <select id="getDeviceList" resultType="com.genersoft.iot.vmp.gb28181.bean.Device">
        SELECT
        id,
        device_id,
        coalesce(custom_name, name) as name,
        password,
        manufacturer,
        model,
        firmware,
        transport,
        stream_mode,
        ip,
        sdp_ip,
        local_ip,
        port,
        host_address,
        expires,
        register_time,
        keepalive_time,
        create_time,
        update_time,
        charset,
        subscribe_cycle_for_catalog,
        subscribe_cycle_for_mobile_position,
        mobile_position_submission_interval,
        subscribe_cycle_for_alarm,
        ssrc_check,
        as_message_channel,
        broadcast_push_after_ack,
        geo_coord_sys,
        on_line,
        media_server_id,
        (SELECT count(0) FROM wvp_device_channel dc WHERE dc.data_type = #{dataType} and dc.data_device_id= de.id) as
        channel_count
        FROM wvp_device de
        <where>
            <if test='status != null'>AND de.on_line=${status}</if>
            <if test='query != null'>AND (
                coalesce(custom_name, name) LIKE concat('%',#{query},'%') escape '/'
                OR device_id LIKE concat('%',#{query},'%') escape '/'
                OR ip LIKE concat('%',#{query},'%') escape '/')
            </if>
        </where>
        order by create_time desc
    </select>

    <select id="getRawChannel" resultType="com.genersoft.iot.vmp.gb28181.bean.DeviceChannel">
        select *
        from wvp_device_channel
        where id = #{id}
    </select>

    <select id="query" resultType="com.genersoft.iot.vmp.gb28181.bean.Device">
        select *
        from wvp_device
        where id = #{id}
    </select>

    <select id="queryByChannelId" resultType="com.genersoft.iot.vmp.gb28181.bean.Device">
        select wd.*
        from wvp_device wd
                 left join wvp_device_channel wdc on wdc.data_type = #{dataType} and wd.id = wdc.data_device_id
        where wdc.id = #{channelId}
    </select>

    <select id="getDeviceBySourceChannelDeviceId" resultType="com.genersoft.iot.vmp.gb28181.bean.Device">
        select wd.*
        from wvp_device wd
                 left join wvp_device_channel wdc on wdc.data_type = #{dataType} and wd.id = wdc.data_device_id
        where wdc.device_id = #{channelDeviceId}
    </select>

    <update id="updateSubscribeCatalog">
        UPDATE wvp_device
        SET subscribe_cycle_for_catalog=#{subscribeCycleForCatalog}
        WHERE id = #{id}
    </update>

    <update id="updateSubscribeMobilePosition">
        UPDATE wvp_device
        SET subscribe_cycle_for_mobile_position=#{subscribeCycleForMobilePosition},
            mobile_position_submission_interval=#{mobilePositionSubmissionInterval}
        WHERE id = #{id}
    </update>

</mapper>